<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR5 - Web-Based OCR Pipeline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        /* Image Processing Section */
        .processing-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .image-panel {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }

        .image-panel h3 {
            margin-bottom: 10px;
            color: #333;
            text-align: center;
        }

        .canvas-container {
            width: 100%;
            height: 400px;
            border: 2px dashed #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            position: relative;
            overflow: hidden;
        }

        .canvas-container canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .canvas-container .placeholder {
            color: #999;
            text-align: center;
            padding: 20px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0f4ff;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #e8edff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #dde5ff;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #ddd;
        }

        .btn-secondary:hover {
            background: #eeeeee;
        }

        .text-output {
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .text-output.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-style: italic;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }

        /* Configuration Section */
        .section {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .section-header {
            background: #f5f5f5;
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #667eea;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header:hover {
            background: #eeeeee;
        }

        .section-content {
            padding: 20px;
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 0.95em;
        }

        .form-group input[type="range"] {
            width: 100%;
        }

        .range-value {
            display: inline-block;
            margin-left: 10px;
            font-weight: 600;
            color: #667eea;
        }

        .model-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .model-card {
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .model-card:hover {
            border-color: #667eea;
        }

        .model-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .model-card.primary {
            border-color: #4caf50;
            background: #f1f8f4;
        }

        .actions {
            text-align: center;
            margin-top: 20px;
        }

        @media (max-width: 1200px) {
            .processing-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç OCR5 - Web-Based OCR Pipeline</h1>
            <p>Upload, condition, and extract text from images</p>
        </div>

        <div class="content">
            <div class="alert success" id="successAlert"></div>
            <div class="alert error" id="errorAlert"></div>
            <div class="alert info" id="infoAlert"></div>

            <!-- Image Upload -->
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <h3>üì§ Upload Image</h3>
                <p>Click here or drag and drop an image file</p>
                <p style="font-size: 0.9em; color: #666;">Supports: PNG, JPG, JPEG, BMP, TIFF, WEBP</p>
            </div>

            <!-- Processing Section -->
            <div class="processing-section">
                <!-- Original Image -->
                <div class="image-panel">
                    <h3>Original Image</h3>
                    <div class="canvas-container">
                        <canvas id="originalCanvas"></canvas>
                        <div class="placeholder" id="originalPlaceholder">No image uploaded</div>
                    </div>
                </div>

                <!-- Conditioned Image -->
                <div class="image-panel">
                    <h3>Conditioned Image</h3>
                    <div class="canvas-container">
                        <canvas id="conditionedCanvas"></canvas>
                        <div class="placeholder" id="conditionedPlaceholder">Will appear after conditioning</div>
                    </div>
                </div>

                <!-- OCR Results -->
                <div class="image-panel">
                    <h3>OCR Results</h3>
                    <div class="text-output empty" id="textOutput">
                        Text will appear here after OCR processing
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="actions">
                <button class="btn btn-primary" id="conditionBtn" disabled>üñºÔ∏è Condition Image</button>
                <button class="btn btn-primary" id="ocrBtn" disabled>üîç Run OCR</button>
                <button class="btn btn-secondary" id="resetBtn">üîÑ Reset</button>
            </div>

            <!-- Backend Configuration -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>üîó Backend Configuration</span>
                    <span>‚ñº</span>
                </div>
                <div class="section-content active" id="backendSection">
                    <div class="form-group">
                        <label>Backend API URL</label>
                        <div class="description" style="font-size: 0.9em; color: #666; margin-bottom: 8px;">
                            Enter your backend URL (e.g., https://your-app.herokuapp.com)
                        </div>
                        <input type="text" id="backendUrl" placeholder="https://your-backend-url.herokuapp.com" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 4px;">
                        <button class="btn btn-secondary" onclick="testBackendConnection()" style="margin-top: 10px;">Test Connection</button>
                        <div id="backendStatus" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
                    </div>
                    <div class="alert info" style="margin-top: 15px;">
                        <strong>Need a backend?</strong> Deploy the backend to Heroku, Railway, or Render. 
                        See <a href="https://github.com/samuelrilling/OCR5#deployment" target="_blank">deployment instructions</a>.
                    </div>
                </div>
            </div>

            <!-- Configuration Section -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>‚öôÔ∏è OCR Configuration</span>
                    <span>‚ñº</span>
                </div>
                <div class="section-content" id="configSection">
                    <!-- OCR Model Selection -->
                    <div class="form-group">
                        <label>Primary OCR Model</label>
                        <select id="ocr_model">
                            <option value="Nanonets-OCR2-3B">Nanonets-OCR2-3B (High Quality)</option>
                            <option value="Chandra-OCR">Chandra-OCR (Medium Quality)</option>
                            <option value="Dots.OCR">Dots.OCR (Medium Quality)</option>
                            <option value="olmOCR-2-7B-1025">olmOCR-2-7B-1025 (High Quality, Slow)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Fallback Models</label>
                        <div class="model-selector" id="fallbackModels">
                            <div class="model-card" data-model="Nanonets-OCR2-3B">Nanonets-OCR2-3B</div>
                            <div class="model-card" data-model="Chandra-OCR">Chandra-OCR</div>
                            <div class="model-card" data-model="Dots.OCR">Dots.OCR</div>
                            <div class="model-card" data-model="olmOCR-2-7B-1025">olmOCR-2-7B-1025</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Conditioning Strength</label>
                        <input type="range" id="strength" min="0" max="100" value="10" oninput="updateRangeValue(this)">
                        <span class="range-value" id="strength_value">10</span>
                    </div>

                    <div class="form-group">
                        <label>PNG Compression</label>
                        <input type="range" id="png_compression" min="0" max="9" value="0" oninput="updateRangeValue(this)">
                        <span class="range-value" id="png_compression_value">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get API base URL from localStorage or default
        function getApiBase() {
            const saved = localStorage.getItem('ocr5_backend_url');
            if (saved && saved !== 'https://your-backend-url.herokuapp.com') {
                return saved;
            }
            // Default based on environment
            if (window.location.origin.includes('github.io')) {
                return null; // No default for GitHub Pages - user must configure
            }
            return 'http://localhost:5000';
        }

        let API_BASE = getApiBase();
        let currentImage = null;
        let conditionedImage = null;

        // Initialize backend URL input
        window.addEventListener('DOMContentLoaded', function() {
            const backendUrlInput = document.getElementById('backendUrl');
            if (API_BASE) {
                backendUrlInput.value = API_BASE;
            } else {
                backendUrlInput.value = '';
            }
            
            backendUrlInput.addEventListener('change', function() {
                const url = this.value.trim();
                if (url && url !== 'https://your-backend-url.herokuapp.com') {
                    API_BASE = url;
                    localStorage.setItem('ocr5_backend_url', url);
                    testBackendConnection();
                } else {
                    API_BASE = null;
                    localStorage.removeItem('ocr5_backend_url');
                }
            });

            // Check backend on load
            if (API_BASE) {
                testBackendConnection();
            } else {
                showBackendStatus('warning', 'Please configure your backend URL above');
            }
        });

        // Initialize
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('uploadArea').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('uploadArea').addEventListener('dragover', handleDragOver);
        document.getElementById('uploadArea').addEventListener('drop', handleDrop);
        document.getElementById('conditionBtn').addEventListener('click', conditionImage);
        document.getElementById('ocrBtn').addEventListener('click', processOCR);
        document.getElementById('resetBtn').addEventListener('click', resetAll);

        // Model card selection
        document.querySelectorAll('.model-card').forEach(card => {
            card.addEventListener('click', function() {
                const primaryModel = document.getElementById('ocr_model').value;
                if (this.dataset.model !== primaryModel) {
                    this.classList.toggle('selected');
                }
            });
        });

        document.getElementById('ocr_model').addEventListener('change', updatePrimaryModel);

        function updatePrimaryModel() {
            const primaryModel = document.getElementById('ocr_model').value;
            document.querySelectorAll('.model-card').forEach(card => {
                card.classList.remove('primary', 'selected');
                if (card.dataset.model === primaryModel) {
                    card.classList.add('primary');
                }
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showAlert('error', 'Please upload an image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentImage = e.target.result;
                    displayImage(img, 'originalCanvas', 'originalPlaceholder');
                    document.getElementById('conditionBtn').disabled = false;
                    document.getElementById('ocrBtn').disabled = true;
                    document.getElementById('conditionedPlaceholder').style.display = 'block';
                    document.getElementById('textOutput').textContent = 'Text will appear here after OCR processing';
                    document.getElementById('textOutput').classList.add('empty');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function displayImage(img, canvasId, placeholderId) {
            const canvas = document.getElementById(canvasId);
            const placeholder = document.getElementById(placeholderId);
            const ctx = canvas.getContext('2d');
            
            placeholder.style.display = 'none';
            canvas.style.display = 'block';
            
            const maxWidth = canvas.parentElement.clientWidth - 30;
            const maxHeight = 400;
            
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }
            if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
        }

        function testBackendConnection() {
            if (!API_BASE) {
                showBackendStatus('error', 'No backend URL configured');
                return;
            }

            const statusDiv = document.getElementById('backendStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<span class="loading"></span> Testing connection...';
            statusDiv.className = 'alert info';

            fetch(`${API_BASE}/api/health`)
                .then(response => {
                    if (response.ok) {
                        showBackendStatus('success', '‚úì Backend connected successfully!');
                    } else {
                        showBackendStatus('error', '‚úó Backend responded with error');
                    }
                })
                .catch(error => {
                    showBackendStatus('error', `‚úó Cannot connect to backend: ${error.message}`);
                });
        }

        function showBackendStatus(type, message) {
            const statusDiv = document.getElementById('backendStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.className = `alert ${type}`;
        }

        async function conditionImage() {
            if (!API_BASE) {
                showAlert('error', 'Please configure your backend URL in the Backend Configuration section');
                return;
            }

            if (!currentImage) {
                showAlert('error', 'Please upload an image first');
                return;
            }

            const btn = document.getElementById('conditionBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Conditioning...';

            try {
                const strength = parseInt(document.getElementById('strength').value);
                const compression = parseInt(document.getElementById('png_compression').value);

                const response = await fetch(`${API_BASE}/api/condition`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: currentImage,
                        config: {
                            strength: strength,
                            png_compression: compression
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    conditionedImage = data.conditioned_image;
                    const img = new Image();
                    img.onload = function() {
                        displayImage(img, 'conditionedCanvas', 'conditionedPlaceholder');
                        document.getElementById('ocrBtn').disabled = false;
                        showAlert('success', 'Image conditioned successfully!');
                    };
                    img.src = data.conditioned_image;
                } else {
                    showAlert('error', data.error || 'Failed to condition image');
                }
            } catch (error) {
                showAlert('error', 'Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üñºÔ∏è Condition Image';
            }
        }

        async function processOCR() {
            if (!API_BASE) {
                showAlert('error', 'Please configure your backend URL in the Backend Configuration section');
                return;
            }

            if (!conditionedImage) {
                showAlert('error', 'Please condition the image first');
                return;
            }

            const btn = document.getElementById('ocrBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Processing OCR...';

            try {
                const model = document.getElementById('ocr_model').value;
                const fallbackModels = Array.from(document.querySelectorAll('.model-card.selected'))
                    .map(card => card.dataset.model);

                const response = await fetch(`${API_BASE}/api/ocr`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: conditionedImage,
                        model: model,
                        fallback_models: fallbackModels,
                        enable_fallback: fallbackModels.length > 0
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const textOutput = document.getElementById('textOutput');
                    textOutput.textContent = data.raw_text || data.markdown_text || 'No text extracted';
                    textOutput.classList.remove('empty');
                    showAlert('success', `OCR completed using model: ${data.model_used}`);
                } else {
                    showAlert('error', data.error || 'OCR processing failed');
                }
            } catch (error) {
                showAlert('error', 'Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîç Run OCR';
            }
        }

        function resetAll() {
            currentImage = null;
            conditionedImage = null;
            document.getElementById('originalCanvas').style.display = 'none';
            document.getElementById('conditionedCanvas').style.display = 'none';
            document.getElementById('originalPlaceholder').style.display = 'block';
            document.getElementById('conditionedPlaceholder').style.display = 'block';
            document.getElementById('textOutput').textContent = 'Text will appear here after OCR processing';
            document.getElementById('textOutput').classList.add('empty');
            document.getElementById('conditionBtn').disabled = true;
            document.getElementById('ocrBtn').disabled = true;
            document.getElementById('fileInput').value = '';
        }

        function showAlert(type, message) {
            const alert = document.getElementById(type + 'Alert');
            if (alert) {
                alert.textContent = message;
                alert.style.display = 'block';
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }

        function toggleSection(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('span:last-child');
            content.classList.toggle('active');
            arrow.textContent = content.classList.contains('active') ? '‚ñº' : '‚ñ∂';
        }

        function updateRangeValue(input) {
            const valueSpan = document.getElementById(input.id + '_value');
            if (valueSpan) {
                valueSpan.textContent = input.value;
            }
        }

        // Backend connection check is now handled in DOMContentLoaded
    </script>
</body>
</html>
